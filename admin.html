<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Admin — Ranking</title>
  <meta name="theme-color" content="#000000" />
  <style>
    :root{ --pad: clamp(16px,3vw,28px); --radius:14px; --shadow:0 12px 40px rgba(0,0,0,.45); }
    *{box-sizing:border-box} html,body{height:100%;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    main{max-width:980px;margin:0 auto;padding:24px var(--pad) 64px;display:grid;gap:18px}
    .card{background:rgba(12,15,15,.72);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow);padding:min(28px,3.2vw)}
    h1,h2{margin:0 0 10px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer;box-shadow:var(--shadow)}
    .btn.primary{background:linear-gradient(180deg,#1fddac 0%,#0fa17e 100%);color:#06261f}
    .btn.secondary{background:#fff;color:#0a0d0c}
    .muted{color:#a7b1af}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
    th{color:#a7b1af;font-weight:600}
    #msg{margin-top:8px;color:#f5a97a}
  </style>
</head>
<body>
  <main>
    <section class="card">
      <h1>Admin — Ranking</h1>
      <div class="muted">Exportar CSV e Zerar ranking (Supabase).</div>
      <div class="row" style="margin-top:12px">
        <button id="btnCsv" class="btn secondary">Exportar CSV</button>
        <button id="btnZerar" class="btn primary">Zerar ranking</button>
        <button class="btn secondary" onclick="location.href='ranking.html'">Ver ranking público</button>
        <button class="btn secondary" onclick="location.href='index.html'">Voltar à Home</button>
      </div>
      <div id="msg" class="muted"></div>
    </section>

    <section class="card">
      <h2>Pré-visualização</h2>
      <table>
        <thead>
          <tr><th>#</th><th>Nome</th><th>Fone</th><th>Tesouro</th><th>Acertos</th><th>Quando</th></tr>
        </thead>
        <tbody id="tbody"><tr><td class="muted" colspan="6">Carregando…</td></tr></tbody>
      </table>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script>
  (function(){
    const sb = supabase.createClient(
      "https://ihajmegcdgwchxslnaep.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImloYWptZWdjZGd3Y2h4c2xuYWVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0OTQzMTgsImV4cCI6MjA3MjA3MDMxOH0.WM36lA9n0PU9qd-DKdrWVB_UzGVXpsfJ984oHiXDU8Y"
    );

    const tbody = document.getElementById('tbody');
    const msg   = document.getElementById('msg');
    const btnCsv= document.getElementById('btnCsv');
    const btnZ  = document.getElementById('btnZerar');

    function setMsg(t, ok=false){ msg.style.color = ok ? '#9FE870' : '#f5a97a'; msg.textContent=t; }

    async function load(){
      setMsg('');
      const {data,error}=await sb.from('ranking')
        .select('id, nome, fone, pontos, tesouro, quando')
        .order('tesouro',{ascending:false})
        .order('pontos',{ascending:false})
        .order('quando',{ascending:true})
        .limit(200);
      if(error){ tbody.innerHTML=`<tr><td colspan="6">Erro: ${error.message}</td></tr>`; return; }
      if(!data.length){ tbody.innerHTML=`<tr><td colspan="6" class="muted">Sem registros.</td></tr>`; return; }
      tbody.innerHTML=data.map((r,i)=>`
        <tr>
          <td>${i+1}</td>
          <td>${r.nome}</td>
          <td>${r.fone}</td>
          <td>${(+r.tesouro||0).toLocaleString('pt-BR')}</td>
          <td>${r.pontos}</td>
          <td>${new Date(r.quando).toLocaleString('pt-BR')}</td>
        </tr>`).join('');
    }

    // Exportar CSV
    btnCsv.addEventListener('click', async ()=>{
      setMsg('Gerando CSV…');
      const {data,error}=await sb.from('ranking')
        .select('nome, fone, pontos, tesouro, quando')
        .order('tesouro',{ascending:false})
        .order('pontos',{ascending:false})
        .order('quando',{ascending:true});
      if(error){ setMsg('Erro ao exportar: ' + error.message); return; }
      const rows = [['nome','fone','pontos','tesouro','quando'], ...data.map(r=>[
        r.nome, r.fone, r.pontos, r.tesouro, r.quando
      ])];
      const csv = rows.map(r=>r.map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `ranking-${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      setMsg('CSV exportado.', true);
    });

    // Zerar ranking (DELETE em tudo)
    btnZ.addEventListener('click', async ()=>{
      if(!confirm('Tem certeza que deseja APAGAR TODO o ranking?')) return;
      setMsg('Apagando…');
      try{
        // Deleta todas as linhas – evita filtro com null.
        const { error } = await sb.from('ranking').delete().gt('id', -1);
        if(error) throw error;
        setMsg('Ranking zerado com sucesso.', true);
        load();
      }catch(e){
        setMsg('Erro ao zerar: ' + (e?.message||e));
        console.warn(e);
      }
    });

    load();
  })();
  </script>
</body>
</html>

