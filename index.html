<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Show do Crentão — Quiz</title>
  <meta name="theme-color" content="#000000" />
  <style>
    :root{
      --bg:#000; --green:#1fddac; --green-700:#0fa17e; --white:#ffffff;
      --card:#0c0f0f; --muted:#aab3b1; --radius:14px;
      --shadow:0 12px 40px rgba(0,0,0,.45); --shadow-soft:0 8px 20px rgba(0,0,0,.35);
      --pad: clamp(16px, 3vw, 28px); --maxw: 1040px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
    img{display:block;max-width:100%}
    .hidden{display:none !important}

    header{
      position:fixed; inset:0 0 auto 0; height:56px;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 var(--pad); z-index:40; pointer-events:none;
      background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,0));
    }
    .brand,.right{pointer-events:auto;display:flex;align-items:center;gap:12px}
    .brand img{height:22px;opacity:.95}
    .title-logo{height:26px;opacity:.96;display:none;filter: drop-shadow(0 2px 8px rgba(0,0,0,.45));}
    @media (max-width:768px){ .title-logo{height:22px;} }

    #hero{
      position:relative; min-height:100svh;
      display:flex; align-items:flex-end; justify-content:center;
      padding: calc(56px + 10svh) var(--pad) calc(20svh);
      background:#000; overflow:hidden;
    }
    #hero .bg{ position:absolute; inset:0; z-index:0; display:grid; place-items:center;}
    #heroImg{ width:100%; height:100%; object-fit:cover; user-select:none; -webkit-user-drag:none; }
    @media (max-width: 768px){
      #hero{padding: calc(56px + 6svh) var(--pad) calc(18svh);}
      #heroImg{ object-fit:contain; aspect-ratio:auto; object-position: center 70px; }
    }
    #hero .cta{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom: calc(12svh + env(safe-area-inset-bottom));
      width:100%; max-width: min(780px, 92vw);
      display:flex; gap:14px; flex-wrap:wrap; justify-content:center; z-index:2;
    }

    .btn{
      appearance:none; border:0; border-radius:18px; padding:18px 28px;
      font-weight:800; letter-spacing:.02em; text-transform:uppercase; cursor:pointer;
      box-shadow: var(--shadow);
      transition: transform .08s ease, box-shadow .2s ease, opacity .2s ease, filter .2s ease;
    }
    .btn:active{transform: translateY(1px); box-shadow: var(--shadow-soft);}
    .btn.primary{ background:linear-gradient(180deg, var(--green) 0%, var(--green-700) 100%); color:#06261f; }
    .btn.secondary{ background:var(--white); color:#0a0d0c }
    .btn.full{ flex:1 1 320px; }

    main{display:grid; gap:28px; padding:24px var(--pad) 48px; max-width:var(--maxw); margin:0 auto}
    .card{
      background:rgba(12,15,15,.72); backdrop-filter: blur(6px);
      border:1px solid rgba(255,255,255,.06); border-radius:var(--radius);
      box-shadow:var(--shadow); padding: min(28px, 3.2vw);
    }
    h2{margin:0 0 6px; font-size:22px}
    .sub{margin:0 0 14px; font-size:14px; color:#a7b1af}
    label{display:block; font-size:14px; margin:14px 0 6px; color:#cdd5d3}
    input[type="text"]{
      width:100%; padding:14px 16px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
      background:#0b0f0e; color:#fff; outline:none;
    }
    .help{font-size:13px; color:#93a29f; margin-top:10px}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .row .btn{min-width:180px}

    #section-form, #section-quiz, #section-ranking{display:none}
    #quizOpcoes label{display:flex;gap:10px;align-items:center;margin:10px 0}

    .confirm-box{ margin-top:14px; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:#0a0f0f; }
    .confirm-title{font-weight:800; margin-bottom:10px;}
    .helpbox{margin-top:12px; font-size:13px; color:#a7b1af}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<header>
  <div class="brand">
    <img src="img/logo.png" alt="Sobrenatural Church" onerror="this.style.display='none'">
  </div>
  <div class="right"><img id="crentaoLogo" class="title-logo" alt="Show do Crentão"></div>
</header>

<section id="hero">
  <div class="bg"><img id="heroImg" alt="Capa – Show do Crentão" class="hidden"></div>
  <div class="cta">
    <button id="btnStart" class="btn primary full">Iniciar</button>
    <button id="btnRanking" class="btn secondary full" onclick="location.href='ranking.html'">Ranking</button>
  </div>
</section>

<main>
  <!-- FORM -->
  <section id="section-form" class="card">
    <h2>Dados do participante</h2>
    <label>Nome completo</label>
    <input id="nome" type="text" placeholder="Ex.: Maria Silva">
    <div class="help">Cada pessoa pode responder <strong>uma vez</strong> por evento.</div>
    <div class="row" style="margin-top:16px">
      <button id="btnEnviarDados" class="btn primary">Começar quiz</button>
    </div>
  </section>

  <!-- QUIZ -->
  <section id="section-quiz" class="card">
    <h2 id="quizPergunta">Carregando…</h2>
    <p id="valorPergunta" class="sub"></p>

    <div class="row" id="lifelines" style="margin:6px 0 10px">
      <button id="btnUni"  class="btn secondary">Universitários</button>
      <button id="btn5050" class="btn secondary">50/50</button>
      <button id="btnPular" class="btn secondary">Pular</button>
    </div>
    <div id="ajudaBox" class="helpbox hidden"></div>

    <div id="quizOpcoes"></div>

    <div id="confirmBox" class="confirm-box hidden">
      <div class="confirm-title">Você tem certeza da resposta?</div>
      <div class="row">
        <button id="btnConfirmar" class="btn primary">Confirmar</button>
      </div>
    </div>

    <div id="posAcertoBox" class="confirm-box hidden">
      <div class="confirm-title" id="posAcertoTitulo"></div>
      <div class="row">
        <button id="btnParar" class="btn secondary">Parar</button>
        <button id="btnContinuar" class="btn primary">Continuar</button>
      </div>
    </div>

    <div class="row" id="actionRow" style="margin-top:16px">
      <button id="btnResponder" class="btn primary">Enviar</button>
      <button id="btnLimpar" class="btn secondary">Limpar</button>
    </div>
  </section>

  <!-- “pós-jogo” -->
  <section id="section-ranking" class="card">
    <h2 id="fimTitulo">Fim do jogo</h2>
    <p id="fimMsg" class="sub"></p>
    <div class="row" style="margin-top:16px">
      <button class="btn secondary" onclick="location.href='index.html'">Voltar ao início</button>
      <button class="btn primary" onclick="location.href='ranking.html'">Ver ranking</button>
    </div>
  </section>
</main>

<script>
(async function(){
  /* ============ CONFIG SUPABASE ============ */
  const SUPABASE_URL = "https://SEU-PROJETO.supabase.co";        // <-- TROQUE
  const SUPABASE_ANON_KEY = "SUA-CHAVE-ANON";                    // <-- TROQUE
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* ============ UI REFS ============ */
  const hero = document.getElementById('hero');
  const heroImg = document.getElementById('heroImg');
  const crentaoLogo = document.getElementById('crentaoLogo');

  const secForm = document.getElementById('section-form');
  const secQuiz = document.getElementById('section-quiz');
  const secFim  = document.getElementById('section-ranking');

  const btnStart   = document.getElementById('btnStart');
  const btnEnviarDados = document.getElementById('btnEnviarDados');

  const nomeInput = document.getElementById('nome');
  const elPerg = document.getElementById('quizPergunta');
  const elSub  = document.getElementById('valorPergunta');
  const elOps  = document.getElementById('quizOpcoes');

  const ajudaBox = document.getElementById('ajudaBox');
  const btnUni  = document.getElementById('btnUni');
  const btn5050 = document.getElementById('btn5050');
  const btnPular= document.getElementById('btnPular');

  const actionRow = document.getElementById('actionRow');
  const btnResp = document.getElementById('btnResponder');
  const btnLimpar = document.getElementById('btnLimpar');

  const confirmBox = document.getElementById('confirmBox');
  const btnConf = document.getElementById('btnConfirmar');

  const posBox = document.getElementById('posAcertoBox');
  const posTitulo = document.getElementById('posAcertoTitulo');
  const btnParar = document.getElementById('btnParar');
  const btnContinuar = document.getElementById('btnContinuar');

  const fimTitulo = document.getElementById('fimTitulo');
  const fimMsg    = document.getElementById('fimMsg');

  function hideAll(){ secForm.style.display='none'; secQuiz.style.display='none'; secFim.style.display='none'; }
  function toggleLogo(show){ crentaoLogo.style.display = show ? '' : 'none'; }

  // capa
  (async function(){
    const caps=['img/cover.png','img/cover.jpg','img/cover.webp','img/capa.png','img/capa.jpg','img/show-crentao-bg.png','img/show-crentao-bg.jpg','img/logosc.png'];
    for (const src of caps){
      const ok = await testaImagem(src);
      if (ok){ heroImg.src=src; heroImg.classList.remove('hidden'); break; }
    }
  })();
  function testaImagem(src){
    return new Promise(r=>{
      const i=new Image(); i.onload=()=>r(true); i.onerror=()=>r(false); i.src=src+'?v='+Date.now();
    });
  }

  btnStart.addEventListener('click', ()=>{
    hero.style.transition='transform .35s ease, opacity .35s ease';
    hero.style.transform='translateY(-8px)'; hero.style.opacity='0';
    setTimeout(()=>{ hero.style.display='none'; hideAll(); toggleLogo(false); secForm.style.display='block'; }, 360);
  });

  /* ================= QUIZ STATE ================= */
  const ladder=[100,200,300,500,1000,2000,5000,10000,20000,50000,100000,200000,300000,500000,750000,1000000];
  const safeIdx=new Set([4,9,14]); // checkpoints: 5/10/15
  let participante = null;

  // pools por nível (preenchidas via Supabase)
  let poolFacil=[], poolMedio=[], poolDificil=[];
  // roteiro: 3 fáceis, 3 médias, 10 difíceis (total 16)
  const roteiro = ['F','F','F','M','M','M','D','D','D','D','D','D','D','D','D','D'];
  let etapa = 0;            // 0..15 (índice da escada)
  let escolha = null;       // índice 0..3 escolhido
  let acertos = 0;
  const lifelines = { uni:true, fifty:true, skip:true };

  function setLifelineButtons(){
    btnUni.disabled=!lifelines.uni;   btnUni.style.opacity=lifelines.uni?1:.5;
    btn5050.disabled=!lifelines.fifty;btn5050.style.opacity=lifelines.fifty?1:.5;
    btnPular.disabled=!lifelines.skip;btnPular.style.opacity=lifelines.skip?1:.5;
  }
  function showActions(){ actionRow.classList.remove('hidden'); confirmBox.classList.add('hidden'); posBox.classList.add('hidden'); }
  function showConfirm(){ actionRow.classList.add('hidden'); confirmBox.classList.remove('hidden'); posBox.classList.add('hidden'); }
  function showPosAcerto(){ actionRow.classList.add('hidden'); confirmBox.classList.add('hidden'); posBox.classList.remove('hidden'); }

  /* ============ Supabase: perguntas + ranking ============ */
  async function carregarPerguntas(){
    const { data, error } = await supabase
      .from('perguntas')
      .select('*')
      .eq('ativo', true)
      .order('id', { ascending:true });

    if(error){ alert('Erro ao carregar perguntas'); console.error(error); return; }

    // Derivar nível por ID (1–3 fácil, 4–6 médio, >=7 difícil).
    poolFacil  = data.filter(q => q.id <= 3);
    poolMedio  = data.filter(q => q.id >= 4 && q.id <= 6);
    poolDificil= data.filter(q => q.id >= 7);

    // embaralhar cada pool
    shuffle(poolFacil); shuffle(poolMedio); shuffle(poolDificil);
  }

  async function salvarRanking({nome, pontos, tesouro}){
    const quando = new Date().toISOString();
    const { error } = await supabase
      .from('ranking')
      .insert([{ nome, pontos, tesouro, quando }]);
    if(error) console.error('Erro ao salvar ranking', error);
  }

  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }

  /* ============ Fluxo do formulário ============ */
  btnEnviarDados.addEventListener('click', async ()=>{
    const n=(nomeInput.value||'').trim();
    if(!n){ alert('Informe seu nome.'); return; }
    participante = { nome:n };
    await carregarPerguntas();
    // valida pools suficientes
    if(poolFacil.length < 3 || poolMedio.length < 3 || poolDificil.length < 10){
      console.warn('Quantidade de perguntas abaixo do esperado. Ainda assim, o jogo vai usar o que houver disponível.');
    }
    iniciarQuiz();
  });

  /* ============ Motor do quiz ============ */
  function iniciarQuiz(){
    hideAll(); secQuiz.style.display='block'; toggleLogo(true);
    etapa=0; escolha=null; acertos=0;
    lifelines.uni=true; lifelines.fifty=true; lifelines.skip=true;
    renderPergunta(); setLifelineButtons();
  }

  let perguntaAtual = null;
  function obterDaPoolDoNivel(nivel){
    const pool = (nivel==='F')?poolFacil : (nivel==='M')?poolMedio : poolDificil;
    if(pool.length===0) return null;
    return pool.shift(); // retira e retorna a próxima
  }

  function nivelAtual(){ return roteiro[Math.min(etapa, roteiro.length-1)]; }

  function renderPergunta(){
    // pega pergunta do nível atual (sem avançar etapa ainda)
    perguntaAtual = obterDaPoolDoNivel(nivelAtual());
    if(!perguntaAtual){
      finalizar(false,false,true); // sem pergunta: encerra como erro técnico (trata como erro)
      return;
    }

    // UI
    elPerg.textContent = perguntaAtual.enunciado;
    elSub.textContent  = `Vale ${ladder[etapa].toLocaleString('pt-BR')} talento(s) de sabedoria`;
    elOps.innerHTML=''; ajudaBox.classList.add('hidden'); ajudaBox.innerHTML='';
    showActions(); setLifelineButtons();

    // monta alternativas
    const ops = [perguntaAtual.a, perguntaAtual.b, perguntaAtual.c, perguntaAtual.d];
    ops.forEach((txt,i)=>{
      const li=document.createElement('label');
      li.innerHTML=`<input type="radio" name="op" value="${i}"> <span>${txt}</span>`;
      elOps.appendChild(li);
    });
    escolha=null;
    elOps.querySelectorAll('input[name=op]').forEach(r=>r.addEventListener('change',()=>{escolha=+r.value;}));
  }

  // Lifelines
  btnUni.addEventListener('click', ()=>{
    if(!lifelines.uni) return;
    lifelines.uni=false; setLifelineButtons();
    const corretaIdx = letraParaIdx(perguntaAtual.correta);
    let votos=[0,0,0,0];
    let base=60+Math.floor(Math.random()*16); // 60–75% na correta
    votos[corretaIdx]=base; let resto=100-base;
    const idxs=[0,1,2,3].filter(i=>i!==corretaIdx);
    idxs.forEach((i,k)=>{
      const part = k<idxs.length-1 ? Math.floor(Math.random()*(resto-(idxs.length-1-k))) : resto;
      votos[i]=part; resto-=part;
    });
    ajudaBox.innerHTML = 'Universitários: ' + votos.map((v,i)=>`<br>(${String.fromCharCode(65+i)}) ${v}%`).join('');
    ajudaBox.classList.remove('hidden');
  });

  btn5050.addEventListener('click', ()=>{
    if(!lifelines.fifty) return;
    lifelines.fifty=false; setLifelineButtons();
    const corretaIdx = letraParaIdx(perguntaAtual.correta);
    const erradas=[0,1,2,3].filter(i=>i!==corretaIdx);
    // remove 2 erradas random
    while(erradas.length>1){
      const remove=erradas.splice(Math.floor(Math.random()*erradas.length),1)[0];
      const input=elOps.querySelector(`input[value="${remove}"]`);
      if(input){ input.disabled=true; input.parentElement.style.opacity=.35; }
    }
  });

  btnPular.addEventListener('click', ()=>{
    if(!lifelines.skip) return;
    lifelines.skip=false; setLifelineButtons();
    // PULAR mantém a fase: carrega OUTRA pergunta do MESMO nível
    renderPergunta();
  });

  // Responder
  btnResp.addEventListener('click', ()=>{
    if(escolha===null){ alert('Escolha uma alternativa.'); return; }
    showConfirm();
  });

  btnConf.addEventListener('click', ()=>{
    const corretaIdx = letraParaIdx(perguntaAtual.correta);
    const ok = (escolha===corretaIdx);

    if(ok){
      acertos++;
      // Oferecer PARAR/CONTINUAR
      const ganhoAtual = ladder[etapa].toLocaleString('pt-BR');
      posTitulo.textContent = `Acertou! Esta fase vale ${ganhoAtual}. Deseja PARAR agora (fica com o último checkpoint) ou CONTINUAR?`;
      showPosAcerto();

      btnParar.onclick = ()=> finalizar(true,false,false);
      btnContinuar.onclick = ()=>{
        etapa++;
        if(etapa<ladder.length){ renderPergunta(); }
        else { finalizar(false,false,false); }
      };
    } else {
      finalizar(false,false,true);
    }
  });

  btnLimpar.addEventListener('click', ()=>{
    elOps.querySelectorAll('input[name=op]').forEach(r=>r.checked=false);
    escolha=null;
  });

  function letraParaIdx(l){
    const map={a:0,b:1,c:2,d:3,A:0,B:1,C:2,D:3};
    return map[l] ?? 0;
  }

  function calculaCheckpoint(){
    if (acertos===0) return 0;
    if (acertos===ladder.length) return ladder[ladder.length-1];
    let premio=0;
    for (let i=0;i<acertos;i++){ if(safeIdx.has(i)) premio=ladder[i]; }
    return premio;
  }

  // finalizar(parouVoluntariamente, pulouNoFim, errou)
  async function finalizar(parou=false, _pulouNoFim=false, errou=false){
    let tesouro=0;
    if (parou) {
      // PARAR: fica com o último checkpoint anterior (não o valor da fase)
      tesouro = calculaCheckpoint();
      fimTitulo.textContent='Você decidiu parar!';
      fimMsg.textContent = `Você garantiu ${tesouro.toLocaleString('pt-BR')} talento(s). Parabéns!`;
    } else if (errou) {
      tesouro = calculaCheckpoint();
      fimTitulo.textContent='Não foi desta vez 😅';
      fimMsg.textContent = `Você errou nesta fase. Seu prêmio é ${tesouro.toLocaleString('pt-BR')} talento(s). Tente novamente!`;
    } else {
      // concluiu todas
      tesouro = ladder[ladder.length-1];
      fimTitulo.textContent='CAMPEÃO! 🎉';
      fimMsg.textContent = `Você concluiu todas as fases e levou ${tesouro.toLocaleString('pt-BR')} talento(s)!`;
    }

    await salvarRanking({ nome:participante.nome, pontos:acertos, tesouro });
    hideAll(); toggleLogo(true); secFim.style.display='block';
  }
})();
</script>
</body>
</html>
